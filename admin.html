<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - 66ä¸­2025çº§1ç­æ¯•ä¸šçºªå¿µ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>66ä¸­2025çº§1ç­</span>
            </div>
            <div class="nav-links">
                <a href="index.html">è¿”å›é¦–é¡µ</a>
                <a href="#" id="auth-btn">é€€å‡ºç™»å½•</a>
            </div>
        </div>
    </nav>

    <!-- ç®¡ç†åå°å†…å®¹ -->
    <div class="admin-container">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> è¯„è®ºç®¡ç†åå°</h1>
            <p>ç®¡ç†æ‰€æœ‰ç”¨æˆ·å‘è¡¨çš„æ¯•ä¸šæ„Ÿè¨€</p>
        </div>

        <div class="comments-list" id="commentsList">
            <div class="comment-loader">
                <i class="fas fa-spinner fa-spin"></i> åŠ è½½è¯„è®ºä¸­...
            </div>
        </div>
    </div>

    <script>
        // LeanCloud åˆå§‹åŒ–
        const APP_ID = 'YOUR_APP_ID';
        const APP_KEY = 'YOUR_APP_KEY';
        
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY
        });
        
        // è·å–å½“å‰ç”¨æˆ·
        const currentUser = AV.User.current();
        
        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        if (!currentUser || currentUser.get('username') !== 'admin') {
            alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®ç®¡ç†åå°');
            window.location.href = 'index.html';
        }
        
        // è·å–è¯„è®º
        async function getComments() {
            const query = new AV.Query('Comment');
            query.descending('createdAt');
            try {
                const comments = await query.find();
                return comments.map(comment => {
                    return {
                        id: comment.id,
                        author: comment.get('author'),
                        content: comment.get('content'),
                        createdAt: comment.createdAt
                    };
                });
            } catch (error) {
                console.error('è·å–è¯„è®ºå¤±è´¥:', error);
                throw error;
            }
        }
        
        // åˆ é™¤è¯„è®º
        async function deleteComment(commentId) {
            const comment = AV.Object.createWithoutData('Comment', commentId);
            try {
                await comment.destroy();
                return true;
            } catch (error) {
                console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                throw error;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            // æ›´æ–°ç”¨æˆ·ç•Œé¢
            updateAuthUI();
            
            // åŠ è½½è¯„è®º
            loadAdminComments();
            
            // é€€å‡ºç™»å½•åŠŸèƒ½
            const authBtn = document.getElementById('auth-btn');
            if (authBtn) {
                authBtn.addEventListener('click', () => {
                    AV.User.logOut();
                    window.location.href = 'index.html';
                });
            }
        });
        
        // åŠ è½½ç®¡ç†è¯„è®º
        async function loadAdminComments() {
            const commentsList = document.getElementById('commentsList');
            
            try {
                const comments = await getComments();
                renderAdminComments(comments);
            } catch (error) {
                commentsList.innerHTML = '<div class="comment-error"><i class="fas fa-exclamation-triangle"></i> åŠ è½½è¯„è®ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        // æ¸²æŸ“ç®¡ç†è¯„è®º
        function renderAdminComments(comments) {
            const commentsList = document.getElementById('commentsList');
            
            if (!comments.length) {
                commentsList.innerHTML = '<div class="no-comments">è¿˜æ²¡æœ‰ä»»ä½•è¯„è®º</div>';
                return;
            }
            
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                const commentCard = document.createElement('div');
                commentCard.className = 'comment-card';
                commentCard.innerHTML = `
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="comment-date">${new Date(comment.createdAt).toLocaleString()}</div>
                    <div class="comment-actions">
                        <button class="action-btn delete-btn" data-id="${comment.id}">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                
                commentsList.appendChild(commentCard);
            });
            
            // æ·»åŠ åˆ é™¤äº‹ä»¶
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const commentId = btn.getAttribute('data-id');
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) {
                        try {
                            await deleteComment(commentId);
                            loadAdminComments();
                            alert('è¯„è®ºå·²åˆ é™¤');
                        } catch (error) {
                            console.error('åˆ é™¤è¯„è®ºå¤±è´¥:', error);
                            alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    }
                });
            });
        }
        
        // æ›´æ–°ç”¨æˆ·ç•Œé¢
        function updateAuthUI() {
            const authBtn = document.getElementById('auth-btn');
            if (authBtn) {
                authBtn.textContent = 'é€€å‡ºç™»å½•';
            }
        }
    </script>
</body>
</html>