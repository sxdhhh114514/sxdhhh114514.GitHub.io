<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重庆市第66中学校2025级1班毕业纪念</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🎓</text></svg>">
    <!-- LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.2/dist/av-min.js"></script>
</head>
<body>

    <!-- 可拖动的主题切换按钮 -->
    <div class="theme-switch" id="themeSwitch">
        <button id="themeButton">
            <i class="fas fa-moon"></i>
            <span>夜间模式</span>
        </button>
    </div>

    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <i class="fas fa-graduation-cap"></i>
                <span>66中2025级1班</span>
            </div>
            <div class="nav-links">
                <a href="#" class="active">首页</a>
                <a href="sxd.html">站长介绍</a>
                <a href="#gallery">照片墙</a>
                <a href="#roster">通讯录</a>
                <a href="#timeline">时光轴</a>
                <a href="#comments">毕业感言</a>
                <a href="login.html" id="auth-btn">登录/注册</a>
                <a href="admin.html" id="adminLink" style="display:none;">管理后台</a>
                <a href="https://lz.qaiu.top/parser?url=https://share.feijipan.com/s/8WMFyDSt">毕业相册电子版下载</a>
            </div>
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container">
        <!-- 头部区域 -->
        <header class="glass-container">
            <div class="school-logo">
                <i class="fas fa-school"></i>
            </div>
            <h1>毕业纪念册</h1>
            <div class="subtitle">青春不散场 · 梦想再起航</div>
            <div class="subtitle">"地球不倒塌我们就不停止维护"<div>
            <div class="class-info">
                <i class="fas fa-map-marker-alt"></i> 重庆市第66中学校 · 
                <i class="fas fa-graduation-cap"></i> 2025级1班
            </div>
        </header>

        <!-- 视频区域 -->
        <section class="video-section glass-container">
            <h2 class="section-title">我们的毕业视频(为了合法我们进行了替换)</h2>
            <div class="video-container">
                <video id="graduationVideo" controls poster="assets/images/video-poster.jpg">
                    <source src="https://lz.qaiu.top/parser?url=https://share.feijipan.com/s/nYMT3t29" type="video/mp4">
                    您的浏览器不支持视频播放。
                </video>
            </div>
        </section>

        <!-- 照片墙 -->
        <section class="gallery-section glass-container" id="gallery">
            <h2 class="section-title">班级记忆</h2>
            <div class="photo-grid">
                <!-- 照片项保持不变 -->
            </div>
        </section>

        <!-- 班级通讯录 -->
        <section class="roster-section glass-container" id="roster">
            <h2 class="section-title">班级通讯录</h2>
            <div class="roster-container" id="rosterContainer">
                <!-- 学生信息通过JavaScript加载 -->
            </div>
        </section>

        <!-- 时间线 -->
        <section class="timeline-section glass-container" id="timeline">
            <h2 class="section-title">初中时光轴</h2>
            <div class="timeline">
                <!-- 时间线项保持不变 -->
            </div>
        </section>

        <!-- 毕业感言 -->
        <section class="comments-section glass-container" id="comments">
            <h2 class="section-title">毕业感言</h2>
            <div class="speech-container" id="speechContainer">
                <div class="speech-loader">
                    <i class="fas fa-spinner fa-spin"></i> 加载评论中...
                </div>
            </div>

            <!-- 评论表单 -->
            <div class="comment-form" id="commentForm">
                <h3>分享你的毕业感言</h3>
                <textarea id="commentInput" placeholder="请输入你的毕业感言..." required></textarea>
                <button id="submitComment">发表感言</button>
                <p class="login-prompt" id="authPrompt">请先<a href="login.html">登录</a>后再发表感言</p>
            </div>
        </section>

        <!-- 页脚 -->
        <footer class="glass-container">
            <p>©sxd 2025 重庆市第66中学校2025级1班毕业纪念网站 站长联系电话:18723143414</p>
            <a href="sxd.html">我的个人站</a>
            <a href="Score/index.html">最新最热中考查分网站</a>
            <p>人生有梦 · 各自精彩</p>
            <p><i class="fas fa-heart"></i> 永远的一班 <i class="fas fa-heart"></i></p>
        </footer>
    </div>

    <!-- 登录弹窗 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>登录账号</h2>
            <form id="modalLoginForm">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="modalUsername" placeholder="用户名" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="modalPassword" placeholder="密码" required>
                </div>
                <button type="submit">登录</button>
            </form>
            <p>还没有账号？<a href="register.html">立即注册</a></p>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ============== LeanCloud 初始化 ==============
        // 替换为你的LeanCloud App ID和App Key
        const APP_ID = 'YOUR_APP_ID';
        const APP_KEY = 'YOUR_APP_KEY';
        
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY
        });

        // ============== 评论功能实现 ==============
        let currentUser = null;
        
        // 获取评论
        async function getComments() {
            const query = new AV.Query('Comment');
            query.descending('createdAt');
            try {
                const comments = await query.find();
                return comments.map(comment => {
                    return {
                        id: comment.id,
                        author: comment.get('author'),
                        content: comment.get('content'),
                        createdAt: comment.createdAt
                    };
                });
            } catch (error) {
                console.error('获取评论失败:', error);
                throw error;
            }
        }

        // 添加评论
        async function addComment(comment) {
            const Comment = AV.Object.extend('Comment');
            const newComment = new Comment();
            
            newComment.set('author', comment.author);
            newComment.set('content', comment.content);
            
            try {
                const savedComment = await newComment.save();
                return {
                    id: savedComment.id,
                    author: savedComment.get('author'),
                    content: savedComment.get('content'),
                    createdAt: savedComment.createdAt
                };
            } catch (error) {
                console.error('添加评论失败:', error);
                throw error;
            }
        }

        // 删除评论
        async function deleteComment(commentId) {
            const comment = AV.Object.createWithoutData('Comment', commentId);
            try {
                await comment.destroy();
            } catch (error) {
                console.error('删除评论失败:', error);
                throw error;
            }
        }

        // ============== 用户认证功能 ==============
        // 用户注册
        async function registerUser(userData) {
            const user = new AV.User();
            user.setUsername(userData.username);
            user.setPassword(userData.password);
            user.setEmail(userData.email);
            
            try {
                const newUser = await user.signUp();
                return newUser;
            } catch (error) {
                console.error('注册失败:', error);
                throw error;
            }
        }

        // 用户登录
        async function loginUser(username, password) {
            try {
                const user = await AV.User.logIn(username, password);
                return user;
            } catch (error) {
                console.error('登录失败:', error);
                throw error;
            }
        }

        // 获取当前用户
        function getCurrentUser() {
            return AV.User.current();
        }

        // 用户登出
        function logoutUser() {
            AV.User.logOut();
        }

        // ============== 页面功能实现 ==============
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化当前用户
            currentUser = getCurrentUser();
            updateAuthUI();
            
            // 加载评论
            loadComments();
            
            // 评论提交
            const submitComment = document.getElementById('submitComment');
            if (submitComment) {
                submitComment.addEventListener('click', async (e) => {
                    e.preventDefault();
                    
                    if (!currentUser) {
                        showLoginModal();
                        return;
                    }
                    
                    const content = document.getElementById('commentInput').value.trim();
                    if (!content) {
                        alert('请输入感言内容');
                        return;
                    }
                    
                    try {
                        await addComment({
                            author: currentUser.get('username'),
                            content: content
                        });
                        
                        document.getElementById('commentInput').value = '';
                        loadComments();
                        alert('感言已提交！感谢分享');
                    } catch (error) {
                        console.error('提交评论失败:', error);
                        alert('提交失败，请重试');
                    }
                });
            }
            
            // 登录弹窗
            const loginModal = document.getElementById('loginModal');
            const modalLoginForm = document.getElementById('modalLoginForm');
            if (modalLoginForm) {
                modalLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('modalUsername').value;
                    const password = document.getElementById('modalPassword').value;
                    
                    try {
                        const user = await loginUser(username, password);
                        currentUser = user;
                        updateAuthUI();
                        hideLoginModal();
                        alert('登录成功！');
                    } catch (error) {
                        alert('登录失败，请检查用户名和密码');
                    }
                });
            }
        });

        // 加载评论
        async function loadComments() {
            const speechContainer = document.getElementById('speechContainer');
            if (!speechContainer) return;
            
            try {
                const comments = await getComments();
                renderComments(comments);
            } catch (error) {
                speechContainer.innerHTML = '<div class="speech-error"><i class="fas fa-exclamation-triangle"></i> 加载评论失败，请刷新重试</div>';
            }
        }

        // 渲染评论
        function renderComments(comments) {
            const speechContainer = document.getElementById('speechContainer');
            if (!speechContainer) return;
            
            speechContainer.innerHTML = '';
            
            if (comments.length === 0) {
                speechContainer.innerHTML = '<div class="no-comments">还没有毕业感言，快来第一个发表吧！</div>';
                return;
            }
            
            comments.forEach((comment, index) => {
                const speechItem = document.createElement('div');
                speechItem.className = 'speech-item';
                speechItem.style.animationDelay = `${index * 0.1}s`;
                
                const header = document.createElement('div');
                header.className = 'speech-header';
                
                const avatar = document.createElement('div');
                avatar.className = 'speech-avatar';
                avatar.textContent = comment.author.charAt(0);
                
                const author = document.createElement('div');
                author.className = 'speech-author';
                author.textContent = comment.author;
                
                const date = document.createElement('div');
                date.className = 'speech-date';
                date.textContent = new Date(comment.createdAt).toLocaleDateString();
                
                header.appendChild(avatar);
                header.appendChild(author);
                header.appendChild(date);
                
                const content = document.createElement('div');
                content.className = 'speech-content';
                content.textContent = comment.content;
                
                speechItem.appendChild(header);
                speechItem.appendChild(content);
                
                // 添加删除按钮（管理员或本人）
                if (currentUser && (currentUser.get('username') === 'admin' || currentUser.get('username') === comment.author)) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-comment';
                    deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                    deleteBtn.title = '删除评论';
                    deleteBtn.onclick = async () => {
                        if (confirm('确定要删除这条评论吗？')) {
                            try {
                                await deleteComment(comment.id);
                                loadComments();
                            } catch (error) {
                                console.error('删除评论失败:', error);
                                alert('删除评论失败，请重试');
                            }
                        }
                    };
                    speechItem.appendChild(deleteBtn);
                }
                
                speechContainer.appendChild(speechItem);
            });
        }

        // 更新用户界面
        function updateAuthUI() {
            const authBtn = document.getElementById('auth-btn');
            const adminLink = document.getElementById('adminLink');
            const commentForm = document.getElementById('commentForm');
            const authPrompt = document.getElementById('authPrompt');
            
            if (authBtn) {
                authBtn.textContent = currentUser ? '退出登录' : '登录/注册';
                authBtn.href = currentUser ? 'javascript:void(0)' : 'login.html';
                
                // 添加退出登录功能
                if (currentUser) {
                    authBtn.onclick = () => {
                        logoutUser();
                        currentUser = null;
                        updateAuthUI();
                        alert('已退出登录');
                    };
                } else {
                    authBtn.onclick = null;
                }
            }
            
            if (adminLink) {
                // 假设管理员用户名为"admin"
                adminLink.style.display = currentUser && currentUser.get('username') === 'admin' ? 'block' : 'none';
            }
            
            if (commentForm && authPrompt) {
                if (currentUser) {
                    commentForm.style.display = 'block';
                    authPrompt.style.display = 'none';
                } else {
                    commentForm.style.display = 'none';
                    authPrompt.style.display = 'block';
                }
            }
        }

        // 显示登录弹窗
        function showLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'block';
        }

        // 隐藏登录弹窗
        function hideLoginModal() {
            const modal = document.getElementById('loginModal');
            modal.style.display = 'none';
        }

        // 点击关闭按钮
        document.querySelector('.close')?.addEventListener('click', hideLoginModal);
        
        // 点击模态框外部关闭
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('loginModal');
            if (e.target === modal) {
                hideLoginModal();
            }
        });
    </script>
</body>
</html>